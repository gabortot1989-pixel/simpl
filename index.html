<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SimplAir‑EC – DIP demo (clean)</title>
  <style>
    :root{ --bg:#0b0e14; --text:#e6e9ef}
    html,body{height:100%;margin:0;background:#0b0e14;color:var(--text);
      font:14px system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
    header{display:flex;align-items:center;gap:10px;padding:8px 12px}
    header h1{margin:0;font-size:16px}
    #viewer{position:relative}
    canvas{display:block}
    .panel{display:flex;flex-wrap:wrap;gap:10px;padding:8px 12px;
      background:#0e1219;border-top:1px solid #182030}
    .group{background:#101521;border:1px solid #1f2937;border-radius:10px;
      padding:8px 10px;display:flex;flex-direction:column;gap:6px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    select,button{background:#111827;color:#e5e7eb;border-radius:8px;
      border:1px solid #374151;padding:4px 8px;cursor:pointer}
    #hud{position:absolute;top:8px;right:8px;background:#111827;
      border-radius:8px;border:1px solid #1f2937;font-size:11px;
      padding:6px 8px;white-space:pre;max-width:60ch}
  </style>
  <script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.152.2/build/three.module.js" } }
  </script>
</head>
<body>
<div id="app">
  <header>
    <h1>SimplAir‑EC – DIP beállító</h1>
    <span style="opacity:.7">clean v1 (csak felső karok)</span>
  </header>
  <div id="viewer">
    <div id="hud">Betöltés…</div>
  </div>
  <div class="panel">
    <div class="group">
      <div class="row">
        <label>EV</label>
        <select id="selEV">
          <option value="1">1</option>
          <option value="0">0</option>
          <option value="3">3</option>
          <option value="6">6</option>
        </select>
        <label>AV</label>
        <select id="selAV">
          <option value="15">15</option>
          <option value="0">0</option>
          <option value="6">6</option>
          <option value="10">10</option>
        </select>
        <label>L1</label>
        <select id="selL1">
          <option value="30">30</option>
          <option value="20">20</option>
          <option value="40">40</option>
          <option value="100">100</option>
        </select>
        <label>L1+L2</label>
        <select id="selL12">
          <option value="60">60</option>
          <option value="30">30</option>
          <option value="80">80</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="row">
        <button id="btnApply">Kombináció alkalmazása</button>
        <button id="btnHoriz">Vízszintes nézet</button>
        <button id="btnUpright">Álló nézet</button>
      </div>
    </div>
    <div class="group">
      <div class="row">
        <label>DIP debug</label>
        <select id="selDipDbg">
          <option>1</option><option>2</option><option>3</option><option>4</option>
          <option>5</option><option>6</option><option>7</option><option>8</option>
        </select>
        <button id="btnTest">Teszt ON/OFF</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';
import {GLTFLoader} from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

const viewer = document.getElementById('viewer');
const hud = document.getElementById('hud');

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(window.innerWidth, window.innerHeight-170);
renderer.outputColorSpace = THREE.SRGBColorSpace;
viewer.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x101316);
const camera = new THREE.PerspectiveCamera(
  45,
  renderer.domElement.width/renderer.domElement.height,
  0.1,200
);
camera.position.set(2.2,1.6,2.2);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dir = new THREE.DirectionalLight(0xffffff,1.0);
dir.position.set(4,5,6);
scene.add(dir);

window.addEventListener('resize', ()=>{
  renderer.setSize(window.innerWidth, window.innerHeight-170);
  camera.aspect = renderer.domElement.width/renderer.domElement.height;
  camera.updateProjectionMatrix();
});

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();

const loader = new GLTFLoader();
const ON_RAD = Math.PI*35/180;

// dipState: index -> {mesh, baseZ, on}
const dips = new Map();

function normName(n){return (n||'').toLowerCase();}

loader.load('SimplAir-EC.glb', gltf=>{
  const root = gltf.scene;
  scene.add(root);

  // forgassuk vízszintesre alapból
  root.rotation.x = -Math.PI/2;

  // fit view
  const box = new THREE.Box3().setFromObject(root);
  const size = box.getSize(new THREE.Vector3()).length();
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  camera.near = size/100;
  camera.far  = size*10;
  camera.position.copy(center.clone().add(new THREE.Vector3(size*0.9,size*0.6,size*0.9)));
  camera.updateProjectionMatrix();

  // Keressük dip-1..8 parenteket
  root.traverse(node=>{
    const nm = normName(node.name);
    const m = nm.match(/^dip[-_]?([1-8])$/);
    if(m){
      const idx = parseInt(m[1],10);
      // gyerek mesh-ek összegyűjtése
      const meshes=[];
      node.traverse(n=>{ if(n.isMesh) meshes.push(n); });
      if(meshes.length===0) return;

      // választás: csak a LEGFELJEBB levő (worldPosition.y szerinti max) legyen a kar,
      // a többit elrejtjük, hogy ne látszódjanak duplán
      const pos = new THREE.Vector3();
      let topMesh = meshes[0];
      let topY=-Infinity;
      for(const mesh of meshes){
        mesh.getWorldPosition(pos);
        if(pos.y>topY){ topY=pos.y; topMesh=mesh; }
      }
      // a többi mesh-t eltüntetjük
      for(const mesh of meshes){
        if(mesh!==topMesh) mesh.visible = false;
      }

      const baseZ = topMesh.rotation.z;
      dips.set(idx,{mesh:topMesh, baseZ, on:true});
    }
  });

  hud.textContent = 'Betöltve. DIP-ek: '+[...dips.keys()].join(', ');
  applyCombo(); // alap kombináció
}, xhr=>{
  if(xhr.total){
    hud.textContent = 'Betöltés: '+(xhr.loaded/xhr.total*100).toFixed(0)+'%';
  }else{
    hud.textContent = 'Betöltés: '+xhr.loaded+' B';
  }
}, err=>{
  console.error(err);
  hud.textContent = 'Hiba a GLB betöltésekor.';
});

function setDip(idx,isOn){
  const d = dips.get(idx);
  if(!d) return;
  d.mesh.rotation.z = d.baseZ + (isOn?0:-ON_RAD);
  d.mesh.updateMatrixWorld(true);
  d.on=isOn;
}

function computeState(evv,avv,l1,l12){
  let S1=false,S2=false;
  if(evv===1){/*00*/} else if(evv===0){S2=true}
  else if(evv===3){S1=true}else if(evv===6){S1=true;S2=true}

  let S3=false,S4=false;
  if(avv===15){/*00*/} else if(avv===0){S4=true}
  else if(avv===6){S3=true}else if(avv===10){S3=true;S4=true}

  let S5=false,S6=false;
  if(l1===30){/*00*/} else if(l1===20){S6=true}
  else if(l1===40){S5=true}else if(l1===100){S5=true;S6=true}

  let S7=false,S8=false;
  if(l12===60){/*00*/} else if(l12===30){S8=true}
  else if(l12===80){S7=true}else if(l12===100){S7=true;S8=true}

  return [S1,S2,S3,S4,S5,S6,S7,S8];
}

function applyCombo(){
  const evv = parseInt(document.getElementById('selEV').value,10);
  const avv = parseInt(document.getElementById('selAV').value,10);
  const l1  = parseInt(document.getElementById('selL1').value,10);
  const l12 = parseInt(document.getElementById('selL12').value,10);
  const st = computeState(evv,avv,l1,l12);
  for(let i=0;i<8;i++){
    setDip(i+1, st[i]);
  }
  hud.textContent = 
    `EV:${evv}  AV:${avv}  L1:${l1}  L1+L2:${l12}
`+
    `DIP-ek (1..8): ${st.map(x=>x?'ON':'OFF').join(' ')}`;
}

document.getElementById('btnApply').addEventListener('click', applyCombo);
['selEV','selAV','selL1','selL12'].forEach(id=>{
  document.getElementById(id).addEventListener('change', applyCombo);
});

document.getElementById('btnHoriz').onclick = ()=>{
  const root = scene.children.find(o=>o.type==='Group');
  if(root) root.rotation.x = -Math.PI/2;
};
document.getElementById('btnUpright').onclick = ()=>{
  const root = scene.children.find(o=>o.type==='Group');
  if(root) root.rotation.x = 0;
};

document.getElementById('btnTest').onclick = ()=>{
  const idx = parseInt(document.getElementById('selDipDbg').value,10);
  const d = dips.get(idx);
  if(!d) return;
  setDip(idx, !d.on);
};

</script>
</body>
</html>
